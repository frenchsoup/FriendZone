<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FriendZone Fantasy Football</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="stylesheet" href="/styles.css">
</head>
<body class="bg-gray-900 text-gray-100">
  <div id="root"></div>
  <script type="text/babel">
    const AppState = () => {
      const [keepers, setKeepers] = React.useState({});
      const [prizes, setPrizes] = React.useState({});
      const [locks, setLocks] = React.useState({});
      const [pendingChanges, setPendingChanges] = React.useState({ keepers: {}, prizes: {} });
      const [selectedYear, setSelectedYear] = React.useState('2025');
      const [isAdminAuthenticated, setIsAdminAuthenticated] = React.useState(false);

      const initializeKeepers = async (year) => {
        if (!keepers[year]) {
          const response = await fetch(`/.netlify/functions/get-data?filename=keepers_${year}.json`);
          const data = await response.json();
          if (data && data.teams) {
            setKeepers(prev => ({ ...prev, [year]: data.teams }));
          } else {
            setKeepers(prev => ({
              ...prev,
              [year]: Array(12).fill().map((_, i) => ({
                team: `Team ${i + 1}`,
                keeper1: '',
                draftCost1: 0,
                tag1: false,
                cost1: 0,
                keeper2: '',
                draftCost2: 0,
                tag2: false,
                cost2: 0,
                remaining: 200,
              })),
            }));
          }
        }
        if (!prizes[year]) {
          const response = await fetch(`/.netlify/functions/get-data?filename=prizes_${year}.json`);
          const data = await response.json();
          if (data && data.weeklyHighScores && data.survivor) {
            setPrizes(prev => ({ ...prev, [year]: data }));
          } else {
            setPrizes(prev => ({
              ...prev,
              [year]: {
                weeklyHighScores: Array(17).fill().map((_, i) => ({
                  week: i + 1,
                  team: '',
                  total: '',
                })),
                survivor: Array(12).fill().map((_, i) => ({
                  week: i + 1,
                  eliminated: '',
                  winner: i === 11 ? '' : undefined,
                })),
              },
            }));
          }
        }
        if (!locks[year]) {
          const response = await fetch(`/.netlify/functions/get-data?filename=locks.json`);
          const data = await response.json();
          setLocks(data || {});
        }
      };

      const handleKeeperChange = (year, index, field, value) => {
        const updatedPending = { ...pendingChanges };
        updatedPending.keepers[year] = updatedPending.keepers[year] || {};
        updatedPending.keepers[year][index] = {
          ...updatedPending.keepers[year][index],
          ...keepers[year][index],
          [field]: value,
        };
        setPendingChanges(updatedPending);
      };

      const handleSaveRow = async (year, index) => {
        const updatedKeepers = { ...keepers };
        const pending = pendingChanges.keepers[year]?.[index] || {};
        const team = { ...updatedKeepers[year][index], ...pending };
        const cost1 = team.tag1 ? (parseInt(team.draftCost1) || 0) + 5 : parseInt(team.draftCost1) || 0;
        const cost2 = team.tag2 ? (parseInt(team.draftCost2) || 0) + 5 : parseInt(team.draftCost2) || 0;
        if ((team.tag1 && !team.draftCost1) || (team.tag2 && !team.draftCost2)) {
          alert('Tagged keepers must have a draft cost greater than 0');
          return;
        }
        team.cost1 = cost1;
        team.cost2 = cost2;
        team.remaining = 200 - cost1 - cost2;
        updatedKeepers[year][index] = team;
        const result = await updateData(`keepers_${year}.json`, updatedKeepers[year], 'update');
        if (result) {
          setKeepers(updatedKeepers);
          const updatedPending = { ...pendingChanges };
          updatedPending.keepers[year][index] = {};
          setPendingChanges(updatedPending);
        }
      };

      const handleWeeklyScoreChange = (year, index, field, value) => {
        if (!isAdminAuthenticated) return;
        const updatedPending = { ...pendingChanges };
        updatedPending.prizes[year] = updatedPending.prizes[year] || {};
        updatedPending.prizes[year].weeklyHighScores = updatedPending.prizes[year].weeklyHighScores || [];
        updatedPending.prizes[year].weeklyHighScores[index] = {
          ...updatedPending.prizes[year].weeklyHighScores[index],
          ...prizes[year].weeklyHighScores[index],
          [field]: value,
        };
        setPendingChanges(updatedPending);
      };

      const handleWeeklyScoreSave = async (year, index) => {
        if (!isAdminAuthenticated) return;
        const updatedPrizes = { ...prizes };
        updatedPrizes[year].weeklyHighScores[index] = {
          ...updatedPrizes[year].weeklyHighScores[index],
          ...pendingChanges.prizes[year]?.weeklyHighScores[index],
        };
        const result = await updateData(`prizes_${year}.json`, updatedPrizes[year], 'update');
        if (result) {
          setPrizes(updatedPrizes);
          const updatedPending = { ...pendingChanges };
          updatedPending.prizes[year].weeklyHighScores[index] = {};
          setPendingChanges(updatedPending);
        } else {
          console.error('Failed to save weekly score');
        }
      };

      const handleSurvivorChange = (year, index, field, value) => {
        if (!isAdminAuthenticated) return;
        const updatedPending = { ...pendingChanges };
        updatedPending.prizes[year] = updatedPending.prizes[year] || {};
        updatedPending.prizes[year].survivor = updatedPending.prizes[year].survivor || [];
        updatedPending.prizes[year].survivor[index] = {
          ...updatedPending.prizes[year].survivor[index],
          ...prizes[year].survivor[index],
          [index === 11 ? 'winner' : 'eliminated']: value,
          [index === 11 ? 'eliminated' : 'winner']: '',
        };
        setPendingChanges(updatedPending);
      };

      const handleSurvivorSave = async (year, index) => {
        if (!isAdminAuthenticated) return;
        const updatedPrizes = { ...prizes };
        updatedPrizes[year].survivor[index] = {
          ...updatedPrizes[year].survivor[index],
          ...pendingChanges.prizes[year]?.survivor[index],
        };
        const result = await updateData(`prizes_${year}.json`, updatedPrizes[year], 'update');
        if (result) {
          setPrizes(updatedPrizes);
          const updatedPending = { ...pendingChanges };
          updatedPending.prizes[year].survivor[index] = {};
          setPendingChanges(updatedPending);
        } else {
          console.error('Failed to save survivor change');
        }
      };

      const updateData = async (filename, data, action) => {
        try {
          const response = await fetch('/.netlify/functions/update-data', {
            method: 'POST',
            body: JSON.stringify({ filename, data, action }),
          });
          return response.ok;
        } catch (error) {
          console.error('Error updating data:', error);
          return false;
        }
      };

      const getRemainingTeams = (year, currentIndex = -1) => {
        const survivorTeams = prizes[year].survivor
          .filter((entry, index) => currentIndex === -1 || index <= currentIndex)
          .map(entry => entry.eliminated || entry.winner)
          .filter(team => team);
        return keepers[year]
          .map(team => team.team)
          .filter(team => team && !survivorTeams.includes(team))
          .sort();
      };

      const handleToggleLock = async (year) => {
        if (!isAdminAuthenticated) return;
        const updatedLocks = { ...locks, [year]: !locks[year] };
        const result = await updateData('locks.json', updatedLocks, 'update');
        if (result) {
          setLocks(updatedLocks);
        }
      };

      return {
        keepers,
        setKeepers,
        prizes,
        setPrizes,
        locks,
        setLocks,
        pendingChanges,
        setPendingChanges,
        selectedYear,
        setSelectedYear,
        isAdminAuthenticated,
        setIsAdminAuthenticated,
        initializeKeepers,
        handleKeeperChange,
        handleSaveRow,
        handleWeeklyScoreChange,
        handleWeeklyScoreSave,
        handleSurvivorChange,
        handleSurvivorSave,
        updateData,
        getRemainingTeams,
        handleToggleLock,
      };
    };

    const App = () => {
      const {
        selectedYear,
        setSelectedYear,
        isAdminAuthenticated,
        setIsAdminAuthenticated,
        initializeKeepers,
      } = window.AppState;

      React.useEffect(() => {
        initializeKeepers(selectedYear);
      }, [selectedYear]);

      const handleLogin = () => {
        const password = prompt('Enter admin password:');
        if (password === 'friendzone2025') {
          setIsAdminAuthenticated(true);
          alert('Login successful!');
        } else {
          alert('Incorrect password');
        }
      };

      const handleLogout = () => {
        setIsAdminAuthenticated(false);
        alert('Logged out');
      };

      return (
        <div className="min-h-screen">
          <nav className="bg-gray-800 p-4 flex justify-between items-center">
            <div className="flex space-x-4">
              <a href="#" onClick={() => window.App.setView('home')} className="text-white hover:text-teal-400">Home</a>
              <a href="#" onClick={() => window.App.setView('rules')} className="text-white hover:text-teal-400">Rules</a>
              <a href="#" onClick={() => window.App.setView('payouts')} className="text-white hover:text-teal-400">Payouts</a>
              <a href="#" onClick={() => window.App.setView('keepers')} className="text-white hover:text-teal-400">Keepers</a>
              <a href="#" onClick={() => window.App.setView('prizes')} className="text-white hover:text-teal-400">Prizes</a>
              {isAdminAuthenticated && (
                <a href="#" onClick={() => window.App.setView('admin')} className="text-white hover:text-teal-400">Admin</a>
              )}
            </div>
            <div>
              {!isAdminAuthenticated ? (
                <button onClick={handleLogin} className="text-white hover:text-teal-400">Login</button>
              ) : (
                <button onClick={handleLogout} className="text-white hover:text-teal-400">Logout</button>
              )}
            </div>
          </nav>
          <main className="px-4 sm:px-6 py-4">
            {window.App.view === 'home' && <window.Home />}
            {window.App.view === 'rules' && <window.Rules />}
            {window.App.view === 'payouts' && <window.Payouts />}
            {window.App.view === 'keepers' && <window.Keepers />}
            {window.App.view === 'prizes' && <window.Prizes />}
            {window.App.view === 'admin' && <window.Admin />}
          </main>
        </div>
      );
    };

    window.AppState = AppState();
    window.App = {
      view: 'home',
      setView: (view) => {
        window.App.view = view;
        ReactDOM.render(<App />, document.getElementById('root'));
      },
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
  <script src="/sections/home.js" type="text/babel"></script>
  <script src="/sections/rules.js" type="text/babel"></script>
  <script src="/sections/payouts.js" type="text/babel"></script>
  <script src="/sections/keepers.js" type="text/babel"></script>
  <script src="/sections/prizes.js" type="text/babel"></script>
  <script src="/sections/admin.js" type="text/babel"></script>
</body>
</html>